#!/bin/bash

# The update for this program can be found at https://github.com/alanshlam/Pentest/tree/main/suricata
#
# This script rotates the eve.json file when it reaches 4GB in size. 
# The rotated filename is tagged with a timestamp by referencing the 
# first line's timestamp of eve.json and using the format YYYY-MM-DD_HHMM 
# for the timestamp. The rotated file has the filename as %Y-%m-%d_%H%M.eve.json.gz.

# The directory where your logs are stored
logdir="/var/log/suricata"

# The directory where you want to store the rotated logs
archivedir="/var/log/suricata/archive"

# The log file you want to rotate
logfile="eve.json"

# Check if the log file is larger than 4GB (4*1024*1024 kBytes)
if [ $(du -k "$logdir/$logfile" | cut -f1) -ge $((4*1024*1024)) ]; then
    # Get the timestamp from the first log entry
    first_entry=$(head -1 $logdir/$logfile)
    timestamp=$(echo $first_entry | awk -F'"' '/"timestamp":/ {print $4}')

    # Format the timestamp to the desired format
    timestamp=$(date -d"$timestamp" +"%Y-%m-%d_%H%M")

    # The rotated log file's name
    rotated="$archivedir/$timestamp.$logfile"

    # Rotate the log file
    mv $logdir/$logfile $rotated

    # Create a new log file
    touch $logdir/$logfile

    # Send a HUP signal to Suricata to tell it to close and reopen its log files
    /bin/kill -HUP `cat /var/run/suricata.pid 2>/dev/null` 2>/dev/null || true

    # Optionally, compress the rotated log file
    gzip $rotated
fi


